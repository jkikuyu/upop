<?php
$data = "txnType=01&respCode=11&channelType=07&currencyCode=156&merId=000000070000017&txnSubType=01&customerInfo=e3Ntc0NvZGU9MTExMTExfQ==&txnAmt=1000&version=5.1.0&signPubKeyCert=-----BEGIN CERTIFICATE-----
MIIEQzCCAyugAwIBAgIFEBJJZVgwDQYJKoZIhvcNAQEFBQAwWDELMAkGA1UEBhMC
Q04xMDAuBgNVBAoTJ0NoaW5hIEZpbmFuY2lhbCBDZXJ0aWZpY2F0aW9uIEF1dGhv
cml0eTEXMBUGA1UEAxMOQ0ZDQSBURVNUIE9DQTEwHhcNMTcxMTAxMDcyNDA4WhcN
MjAxMTAxMDcyNDA4WjB3MQswCQYDVQQGEwJjbjESMBAGA1UEChMJQ0ZDQSBPQ0Ex
MQ4wDAYDVQQLEwVDVVBSQTEUMBIGA1UECxMLRW50ZXJwcmlzZXMxLjAsBgNVBAMU
JTA0MUBaMjAxNy0xMS0xQDAwMDQwMDAwOlNJR05AMDAwMDAwMDEwggEiMA0GCSqG
SIb3DQEBAQUAA4IBDwAwggEKAoIBAQDDIWO6AESrg+34HgbU9mSpgef0sl6avr1d
bD/IjjZYM63SoQi3CZHZUyoyzBKodRzowJrwXmd+hCmdcIfavdvfwi6x+ptJNp9d
EtpfEAnJk+4quriQFj1dNiv6uP8ARgn07UMhgdYB7D8aA1j77Yk1ROx7+LFeo7rZ
Ddde2U1opPxjIqOPqiPno78JMXpFn7LiGPXu75bwY2rYIGEEImnypgiYuW1vo9UO
G47NMWTnsIdy68FquPSw5FKp5foL825GNX3oJSZui8d2UDkMLBasf06Jz0JKz5AV
blaI+s24/iCfo8r+6WaCs8e6BDkaijJkR/bvRCQeQpbX3V8WoTLVAgMBAAGjgfQw
gfEwHwYDVR0jBBgwFoAUz3CdYeudfC6498sCQPcJnf4zdIAwSAYDVR0gBEEwPzA9
BghggRyG7yoBATAxMC8GCCsGAQUFBwIBFiNodHRwOi8vd3d3LmNmY2EuY29tLmNu
L3VzL3VzLTE0Lmh0bTA5BgNVHR8EMjAwMC6gLKAqhihodHRwOi8vdWNybC5jZmNh
LmNvbS5jbi9SU0EvY3JsMjQ4NzIuY3JsMAsGA1UdDwQEAwID6DAdBgNVHQ4EFgQU
mQQLyuqYjES7qKO+zOkzEbvdFwgwHQYDVR0lBBYwFAYIKwYBBQUHAwIGCCsGAQUF
BwMEMA0GCSqGSIb3DQEBBQUAA4IBAQAujhBuOcuxA+VzoUH84uoFt5aaBM3vGlpW
KVMz6BUsLbIpp1ho5h+LaMnxMs6jdXXDh/du8X5SKMaIddiLw7ujZy1LibKy2jYi
YYfs3tbZ0ffCKQtv78vCgC+IxUUurALY4w58fRLLdu8u8p9jyRFHsQEwSq+W5+bP
MTh2w7cDd9h+6KoCN6AMI1Ly7MxRIhCbNBL9bzaxF9B5GK86ARY7ixkuDCEl4XCF
JGxeoye9R46NqZ6AA/k97mJun//gmUjStmb9PUXA59fR5suAB5o/5lBySZ8UXkrI
pp/iLT8vIl1hNgLh0Ghs7DBSx99I+S3VuUzjHNxL6fGRhlix7Rb8
-----END CERTIFICATE-----&signMethod=01&accNo=Y7Fa1uby9YLbfZcbOS2kBuPdMExsOipa3I5Usf85xqxJnR/Ab8mj9o7i3d65/3fVwSQdey8EIDp0j85GciENEoKEakDMj1QyFj4UsIqfTjA0uvPPCSrnbDarfZN0XMaWgUGxDlsyD8nymKHxxRZAF0Dfapjge8qx3lmeyAc8ljRSk2vEeuBZsLoTRbOMpQULoEQE+I1O0u80fIpss3y12LM46YWfZ4edY7QG1zZKhFLaJbURVIYPovA9LzAqtiVVoij9HLIF9KtWX+KrMpcqQVAWJSyq6UeKgvx8XJ8BIo2bxH7HIiIRT9omY0mffv522b9uzjWxnad+YnG36hXdDA==&backUrl=http://222.222.222.222:8080/ACPSample_WuTiaoZhuan_Token/backRcvResponse&certId=69629715588&encoding=UTF-8&respMsg=[9100004]Signature verification failed&bizType=000000&encryptCertId=68759622183&signature=RIWiPiCtDdfQpoujjhGV2ZyS2AQzHmL9SqYOJdASGF9czR9zpV9kvXpffmtTqOliRKtnTe+pC8twfUhoJ1ZOoBDJHMdEXvpGrYWH0BQTaCGflsQkq/5CXWIxyUXVmiJKnadUeOKPxkVr/JZYJBaYUceteUDBBk8NNtHEMqktUemfrJeK4rk7M8bCtO1eRilcyoAmuPeg2ks/aRc3ARXMS8y9f8RjcC8+yVXQNc8ewm02SeIeGDE9JW7OLpqJInLfuy/wkTGkXcrJW/NJvi/I2fd3WNaR+UuapmSGH9YYjPoCXasThrRzucu/Gc/Xd3TdrZN+T8GU4PDNqBLZTLvYkw==&orderId=20191008171230&txnTime=20191008171230&accessType=0";

$ares = explode("&",$data);
//Svar_dump($ares);
foreach( $ares as $item){
	$temp = explode("=",$item);
	$key=$temp[0];
	$value=$temp[1];
	$resp[$key] =  $value;
	
}

foreach($resp as $key => $value ){
   if (  $key==='signPubKeyCert'){
	   $pubcertStr=$value;
	   break;
   }
}
print_r($pubcertStr);
$cert = openssl_x509_parse($pubcertStr);
if( $cert['validFrom_time_t'] > time() || $cert['validTo_time_t'] < time() )
    echo "Certificate is expired.";

//require_once('classesAutoload.php');
/*$headers = ["Content-type:application/x-www-form-urlencoded;charset=UTF-8"];
error_reporting(E_ALL);
ini_set('display_errors', TRUE);
ini_set('display_startup_errors', TRUE);
$url = 'https://gateway.test.95516.com/gateway/api/backTransReq.do';
$port = 443;
$timeout = 30;

$bizType="000000";


$data = "";
$pass = "000000";
$encSuccess = false;
$txnsubtype="01";
$backUrl="http://222.222.222.222:8080/ACPSample_WuTiaoZhuan_Token/backRcvResponse";
$signature="";
$customerInfo = "e3Ntc0NvZGU9MTExMTExfQ==";
$txntype="01";
$channeltype="07";
$certId="69629715588";
$encoding="UTF-8";
$version = "5.1.0";
$accessType="0";
$encryptedCertId = "68759622183";
$txnTime = "20191007000620";
$orderid ="20191007000620";

$merchantID="000000070000017";
$currencyCode="156";
$signMethod="01";
$txnAmt ="1000";
$b64 = "";

          
if ($encfile = file_get_contents("/home/jkikuyu/ipay/upop/certs/test/acp_test_enc.cer")) {
	//echo "encryption cert";
	$encSuccess = true;
    $publickey = openssl_pkey_get_public($encfile);
	$data=openssl_x509_parse($encfile,true);
	echo "serial :".$data['serialNumber'];
    $keyData = openssl_pkey_get_details($publickey);
    $pubkey=$keyData['key'];
		//print_r($keyData);

	//echo $pubkey;
    $card="6216261000000000018";
    openssl_public_encrypt($card, $accNo, $pubkey,OPENSSL_PKCS1_PADDING);   
    $accNo = base64_encode($accNo);
	//echo $accNo;
}

else{
    echo "Error: Unable to read the cert file\n";
    exit;
}

if (!$cert_store = file_get_contents("/home/jkikuyu/ipay/upop/certs/test/acp_test_sign.pfx")) {
	echo "Error: Unable to read the cert file\n";
	exit;
}
  $data= [
	   		"bizType"=>$bizType,
		   	"txnSubType"=>$txnsubtype,
	   		"orderId"=>$orderid,
            "backUrl"=>$backUrl,
	   		"accNo" =>$accNo,
	 	   	"customerInfo"=>$customerInfo,
	   		"txnType"=>$txntype,
	        "channelType"=>$channeltype,
	   		"certId"=>$certId,
	        "encoding"=>$encoding,
	   		"version"=>$version,
            "accessType"=>$accessType,
	   		"encryptCertId"=>$encryptedCertId,
	   		"txnTime"=>$txnTime,
            "merId"=>$merchantID,
            "currencyCode"=>$currencyCode,
	        "signMethod" =>$signMethod, 
		   	"txnAmt"=>$txnAmt
		   ];
 			$orig = $data;
            ksort($data);

			$str="";
		 	foreach($data as $key => $value) {
				$str.= $key."=";
					
					$str.= $value."&";

            }
			$len = strlen($str);
			$len -=1;
			$str = substr($str, 0, $len);
           // echo "<br />string to sign :<br />".$str."<br/>";
            $hashed = hash ("sha256",$str);
			if (openssl_pkcs12_read($cert_store, $certs, $pass)) {
                $privateKey = $certs['pkey'];
  
                if (openssl_sign ( $hashed , $signature ,  $privateKey, "sha256WithRSAEncryption" )){
                    $b64 = base64_encode($signature);
    

                }
                else{
                    echo "error in signing";
                }
            }


		$data["signature"]=$b64;
		ksort($data);
		$strData=""; 
        foreach($data as $key => $value) {
            $strData.= $key."=";

                $strData.= urlencode($value);

                $strData.="&";

        }
        $strData = substr($strData,0,strlen($strData)-1);
		$strData = "accNo=fkp3fOrP61lDTYnUdGkPvDa5IeWszKZQV4h6wz337xIo%2FdWjuO6Am6Q%2BC20HQO4NklVTKaAMqlWmc%2BmuV%2FdgROBYPdFJbn%2BAmT4frpMEOtPx9iqJA4s1F%2B50peVB39mvhxBhSpv6N9jSzb%2B%2BkneF9fDpKHLXpsHvRDYPOfoSOfpLTAl%2FIiVg9NLtgBAohdAS%2FVaDUdnNINF9HyuaW%2BlxDN6w3RW6sC4%2F%2BHNyA9NN5E4PJPe196Iq6NeSbIE8O7iRdosYbAegm1eK%2FzD5emlBolesg93BlQ8uImfLCpEEOBc73Mwp%2F8ecPl%2BgG1j7hH%2F1tyXwkD4Fuc7tP2wgxckgDg%3D%3D&accessType=0&backUrl=https%3A%2F%2Fipay-staging.ipayafrica.com%2Fupop%2Funionpaycbk%2FbackRcvResponse.php&bizType=000000&certId=69629715588&channelType=07Â¤cyCode=156&customerInfo=e3Ntc0NvZGU9MTExMTExfQ%3D%3D&encoding=UTF-8&encryptCertId=68759622183&merId=000000070000017&orderId=1234567&signMethod=01&txnAmt=1&txnSubType=01&txnTime=20190618233948&txnType=01&version=5.1.0&signature=hlKgg%2BFPObOddPh2OxlhA0ybHFsV6hkxLsrT8s0%2BtofPXiBvK%2FNCIyGqcz2L1CiZSW1Zek44GasqQeWg2VZGkVkm35998nB4czU2d1KY1sX4SXeyhIzKe%2FJz53%2Bu8NbcLz9rqsqoOmaWaqEvyMQZ2kSCZtMpFCsp4%2Bvn0EYqhlt%2FFNOkicwPBz1cRTwrY%2FarA9U8qJuJQ%2F6ceV8mwrK%2Fgz8ZvK8xeOCa6Z0pSfLPnDVxbUAygI51z%2FV%2F9SCe2i7YeWy%2FrLAbpJ1sDEnA86YmuUYZ%2B1acgVNq%2BM%2F4OS1e%2FEtPh9UwubWW1QreOj9Yshg%2FcjLut2%2FxuZX8GpiwQvb9Ow%3D%3D";
		//echo "<br />string to send :<br />".$strData."<br/>";



	$curl = curl_init();
		curl_setopt($curl, CURLOPT_URL, $url);
		curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, 0);
		curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, 0);
		//set request headers
		curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
		curl_setopt($curl, CURLOPT_PORT, $port);

		//request method is POST
		curl_setopt($curl, CURLOPT_POST, 1);
		//request body
		curl_setopt($curl, CURLOPT_POSTFIELDS, $strData);


		//return transfer response as string to the $curl resource
		curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);

		//output verbose info
		curl_setopt($curl, CURLOPT_VERBOSE, 1);

		$output = curl_exec($curl);

		echo "result <br />".$output;
*/




function decryptCard($package, $cert_store){
	$pass = "000000";
	openssl_pkcs12_read($cert_store, $certs, $pass);
	$res=$certs['pkey'];
	$b64dec = base64_decode($package); 

	openssl_private_decrypt($b64dec,$decrypted,$res);
	echo "plain text ". $decrypted;

}


?>
